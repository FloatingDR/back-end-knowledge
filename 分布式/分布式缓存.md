# 1. 缓存方案

**客户端方案**：在客户端配置多个缓存的节点，通过缓存写入和读取算法策略来实现分布式，从而提高缓存的可用性；

**中间代理层方案**：在应用代码和缓存节点之间增加代理层，客户端所有的写入和读取的请求都通过代理层，而代理层中内置高可用策略，帮助提升缓存系统的高可用；

**服务端方案**：R edis 2.4 版本后提出的 Redis Sentinel （哨兵）方案；

## 1.1. 客户端方案

在客户端方案中，需要关注缓存的写和读两个方面：写入数据事，需要把被写入缓存的数据分散到多个节点中，即进行数据分片；读数据时，可以利用多组的缓存来容错，提升缓存系统的可用性。读数据可以使用主从和多副本两种策略，两种策略是为了解决不同的问题而提出的。

### 缓存数据如何分片

单一的缓存节点受到机器内存、网卡带宽和单节点请求量的限制，不能承担比较高的并发，因此需要考虑将数据分片，依照分片算法将数据打散到多个不同的节点上，每个节点上存储部分数据。

**一般来讲，分片算法常见的就是Hash分片算法和一致性Hash分片算法两种。**

Hash分片的缺点是，当增加或者减少缓存节点时，缓存总的节点个数变化造成计算出来的节点发生变化，造成缓存不可用。

而一致性Hash算法可以很好地解决增加和删除节点时命中率下降的问题。但是，如果缓存节点在圆环上分布不平均，会造成部分缓存节点的压力较大，当某个节点故障时，这个节点要承担所有的访问都会被顺移到另一个节点上，会对后面这个节点造成压力，为此可以引入**虚拟节点**。其次，一致性Hash算法会有脏数据问题，所以，在使用时**一定要设置缓存的过期时间**，这样当发生漂移时，之前存储的脏数据可能已已经过期，就可以减少存在脏数据的几率。

## 1.2. 中间代理层方案

虽然客户端方案已经能解决大部分的问题，但是只能在单一语言系统之间复用，用其他语言就需要重新写一套，而**中间代理层的方案就可以解决这个问题**。

## 1.3. 服务端方案

Redis 在 2.4 版本中提出了 Redis Sentinel 模式来解决主从 Redis 部署时的高可用问题， 它可以在主节点挂了以后自动将从节点提升为主节点，保证整体集群的可用性。Redis Sentinel 也是集群部署的，这样可以避免 Sentinel 节点挂掉造成无法自动故障恢复 的问题，每一个 Sentinel 节点都是无状态的。在 Sentinel 中会配置 Master 的地址， Sentinel 会时刻监控 Master 的状态，当发现 Master 在配置的时间间隔内无响应，就认为 Master 已经挂了，Sentinel 会从从节点中选取一个提升为主节点，并且把所有其他的从节 点作为新主的从节点。Sentinel 集群内部在仲裁的时候，会根据配置的值来决定当有几个 Sentinel 节点认为主挂掉可以做主从切换的操作，也就是集群内部需要对缓存节点的状态 达成一致才行。

Redis Sentinel 不属于代理层模式，因为对于缓存的写入和读取请求不会经过 Sentinel 节 点。Sentinel 节点在架构上和主从是平级的，是作为管理者存在的，**所以可以认为是在服 务端提供的一种高可用方案。**

# 2. 缓存穿透

缓存穿透是指从缓存中没有查到数据，而不得不从后端系统（比如数据库）中查询的情况。

缓存穿透的解决方案：**回种空值以及使用布隆过滤器**。

回种空值缺点：缓存内会有大量的空值缓存，会浪费缓存的存储空间，并且如果缓存空间被占满了，还会剔除一些已经缓存的信息反而导致缓存命中率的下降；

布隆过滤器的缺点：1. 它在判断元素是否在集合中时有一定的错误几率**（当布隆过滤器判断元素在集合中时，这个元素可能不在集合中，但当他判断这个元素不在集合中时，它一定不在集合中，这一点非常适合解决缓存穿透的问题）**；2. 不支持删除元素；

虽然布隆过滤器存在误判的情况，但是还是会减少缓存穿透情况的发生，只是需要尽量减少误判的几率，这样布隆过滤器的判断正确的几率更高，对缓存的穿透也更少。一个解决方案是：使用多个Hash算法为元素计算出多个Hash值，**只有所有Hash值对应的数组中的值都为1时，才会认为这个元素在集合中**。布隆过滤器不支持删除元素的缺陷也和Hash碰撞有关。

> 极端情况下，有一个极热点的缓存项，它一旦失效会有大量请求穿透到数据库，这会对数据库造成瞬时极大的压力，这个场景叫做"dog-pile effect"（狗桩效应）。这也是经典的缓存并发穿透问题。解决方案有：
>
> 1. 在代码中，控制在某一个热点缓存项失效之后启动一个后台线程，穿透到数据库，将数据加载到缓存中，在缓存未加载之前，所有访问这个缓存的请求都不再穿透而直接返回。
> 2. 通过设置分布式锁，只有获取到锁的请求才能够穿透数据库。